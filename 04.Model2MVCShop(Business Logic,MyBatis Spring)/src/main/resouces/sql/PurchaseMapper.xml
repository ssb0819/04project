<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		
<mapper namespace="ProductMapper">

	<resultMap id="productSelectMap" type="product">
		<result property="fileName" column="image_file" jdbcType="VARCHAR"/>
		<result property="manuDate" column="manufacture_day" jdbcType="VARCHAR"/>
		<result property="price" column="price" jdbcType="NUMERIC"/>
		<result property="prodDetail" column="prod_detail" jdbcType="VARCHAR"/>
		<result property="prodName" column="prod_name" jdbcType="VARCHAR"/>
		<result property="prodNo" column="prod_no" jdbcType="NUMERIC"/>
		<result property="regDate" column="reg_date" jdbcType="DATE"/>
	</resultMap>
	
	<insert id="insertProduct" parameterType="product">
		INSERT
		INTO product(prod_no, prod_name, prod_detail, manufacture_day, price, image_file, reg_date)
		VALUES(seq_product_prod_no.NEXTVAL,#{prodName},#{prodDetail},#{manuDate},#{price},#{fileName},SYSDATE)	
	</insert>
	
	<select id="findProduct" parameterType="_int" resultMap="productSelectMap">
		SELECT 
		prod_no, prod_name, prod_detail, manufacture_day, price, image_file, reg_date 
		FROM product 
		WHERE prod_no = #{value}
	</select>
	
	<update id="updateProduct" parameterType="product" >
		UPDATE product
		<set>
			prod_name=#{prodName}, prod_detail=#{prodDetail}, manufacture_day=#{manuDate}, price=#{price}, image_file=#{fileName}
		</set> 
		WHERE prod_no=#{prodNo}		
	</update>
	
	<select id="getProductList" parameterType="search" resultMap="productSelectMap">				
		SELECT 
		prod_no, prod_name, prod_detail, manufacture_day, price, image_file, reg_date 
		FROM ( SELECT inner_table. * ,  ROWNUM AS row_seq
				FROM (			
						SELECT * 
						FROM product p, transaction t
						<where> 
							p.prod_no = t.prod_no(+) AND p.prod_name LIKE '%'||#{searchKeyword}||'%'
							<if test="searchPriceMin>0">
								AND p.price %gt;= #{searchPriceMin}
							</if>
							<if test="searchPriceMax>0">
								AND p.price %lt;= #{searchPriceMax}
							</if>
						</where>
						ORDER BY t.tran_status_code NULLS FIRST, p.prod_no DESC		
				) inner_table
				WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum}		
	</select>
	
	<delete id="deleteProduct" parameterType="_int">
		DELETE
		FROM product
		WHERE prod_no = #{value}
	</delete>

</mapper>